{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/how-to-fix-wsl2-and-cisco-vpn","result":{"data":{"markdownRemark":{"html":"<h2>The problem</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">Err:1 http://archive.ubuntu.com/ubuntu focal InRelease\n  Temporary failure resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nErr:2 http://security.ubuntu.com/ubuntu focal-security InRelease\n  Temporary failure resolving <span class=\"token string\">'security.ubuntu.com'</span>\nErr:3 http://archive.ubuntu.com/ubuntu focal-updates InRelease\n  Temporary failure resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nErr:4 http://archive.ubuntu.com/ubuntu focal-backports InRelease\n  Temporary failure resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nReading package lists<span class=\"token punctuation\">..</span>. Done\nW: Failed to fetch http://archive.ubuntu.com/ubuntu/dists/focal/InRelease  Temporary failure   resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nW: Failed to fetch http://archive.ubuntu.com/ubuntu/dists/focal-updates/InRelease  Temporary   failure resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nW: Failed to fetch http://archive.ubuntu.com/ubuntu/dists/focal-backports/InRelease    Temporary failure resolving <span class=\"token string\">'archive.ubuntu.com'</span>\nW: Failed to fetch http://security.ubuntu.com/ubuntu/dists/focal-security/InRelease    Temporary failure resolving <span class=\"token string\">'security.ubuntu.com'</span>\nW: Some index files failed to download. They have been ignored, or old ones used instead.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On wsl2 <code class=\"language-text\">sudo apt update</code> will fail when connected to Cisco Anyconnect VPN but without\nvpn it works fine. The problem is when you are connected to anyconnect, wsl fails to resolve\nthe DNS.</p>\n<h2>The solution</h2>\n<ol>\n<li>Connect Cisco Anyconnect VPN, then open up powershell as Admin and run the following commands\nto get the all the available DNS/nameservers. Take note of the DNS/namservers will need later.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">Get-DnsClientServerAddress -AddressFamily IPv4 <span class=\"token operator\">|</span> Select-Object -ExpandProperty ServerAddresses</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ol start=\"2\">\n<li>Then on the same powershell run the following. This will get the search domain that will\nneed later on with the nameservers above.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">Get-DnsClientGlobalSetting <span class=\"token operator\">|</span> Select-Object -ExpandProperty SuffixSearchList</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ol start=\"3\">\n<li>Open up wsl, and run the following commands.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> unlink /etc/resolv.conf <span class=\"token comment\"># this will unlink the default wsl2 resolv.conf</span>\n\n<span class=\"token comment\"># This config will prevent wsl2 from overwritting the resolve.conf file everytime</span>\n<span class=\"token comment\"># you start wsl2</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> -a /etc/wsl.conf</span>\n[network]\ngenerateResolvConf = false\nEOF</span>\n\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> -a /etc/resolv.conf</span>\nnameserver 10.50... # The company DNS/nameserver from the command in step 1\nnameserver 10.50... # The company DNS/nameserver from the command in step 1\nnameserver 8.8.8.8\nnameserver 8.8.4.4\nsearch this.searchdomain.com # The search domain that we got from step 2\nEOF</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol start=\"4\">\n<li>Change Cisco Anyconnect metric from default 1 to 6000 inside powershell</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">Get-NetAdapter <span class=\"token operator\">|</span> Where-Object <span class=\"token punctuation\">{</span><span class=\"token variable\">$_</span>.InterfaceDescription -Match <span class=\"token string\">\"Cisco AnyConnect\"</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> Set-NetIPInterface -InterfaceMetric <span class=\"token number\">6000</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ol start=\"5\">\n<li>Restart wsl2 on the same elevated powershell, then you can open up wsl2 and it should connect to\nthe internet.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">Restart-Service LxssManager</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>References</h3>\n<p><a href=\"https://github.com/microsoft/WSL/issues/5068\">https://github.com/microsoft/WSL/issues/5068</a>\n<a href=\"https://github.com/microsoft/WSL/issues/4277\">https://github.com/microsoft/WSL/issues/4277</a></p>","frontmatter":{"date":"September 27, 2020","path":"/blog/how-to-fix-wsl2-and-cisco-vpn","title":"How to fix WSL2 and Cisco Anyconnect VPN internet issue","tags":["windows","wsl","Today I learned","vpn"]}}},"pageContext":{}},"staticQueryHashes":["3649515864","63159454"]}